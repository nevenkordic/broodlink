# Broodlink — Multi-agent AI orchestration
# Copyright (C) 2025–2026 Neven Kordic <neven@broodlink.ai>
# SPDX-License-Identifier: AGPL-3.0-or-later

[formula]
name = "ci-fix"
version = "1.0.0"
description = "Diagnose and fix CI pipeline failures: identify failing check, trace cause, apply fix"

[[steps]]
name = "identify_failure"
agent_role = "analyst"
tools = ["recall_memory", "semantic_search"]
prompt = "Identify the CI failure: {{failure_description}}. Determine which check failed (rustfmt, clippy, test, shellcheck, cargo-deny, cargo-audit, build) and gather the error output."
output = "failure_info"

[[steps]]
name = "trace_cause"
agent_role = "analyst"
tools = ["semantic_search", "recall_memory", "get_work_log"]
prompt = "Trace the root cause of the CI failure. Check recent commits, dependency changes, and known CI gotchas from memory (e.g., cargo-audit ignore list, rustfmt rules)."
input = "failure_info"
output = "root_cause"

[[steps]]
name = "apply_fix"
agent_role = "developer"
tools = ["log_work", "store_memory", "log_decision"]
prompt = "Apply the fix for the CI failure. Log the work done. If the fix involves a policy decision (e.g., ignoring an advisory), log the decision with reasoning."
input = "root_cause"
output = "fix_applied"

[formula.parameters]
failure_description = { type = "string", required = true, description = "Description of the CI failure or link to the failing run" }
