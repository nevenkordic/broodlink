[broodlink]
env     = "local"
version = "0.1.0"

[profile]
name              = "dev"
tls_interservice  = false
nats_cluster      = false
dolt_replication  = false
postgres_replicas = 0
qdrant_distributed = false
audit_residency   = false

[residency]
region              = "local"
data_classification = "internal"
allowed_egress      = []

[dolt]
host            = "127.0.0.1"
port            = 3307
database        = "agent_ledger"
user            = "root"
password_key    = "BROODLINK_DOLT_PASSWORD"
min_connections = 2
max_connections = 5

[postgres]
host            = "127.0.0.1"
port            = 5432
database        = "broodlink_hot"
user            = "postgres"
password_key    = "BROODLINK_POSTGRES_PASSWORD"
min_connections = 5
max_connections = 20

[nats]
url            = "nats://localhost:4222"
subject_prefix = "broodlink"

[qdrant]
url        = "http://localhost:6333"
collection = "broodlink_memory"
api_key    = "BROODLINK_QDRANT_API_KEY"

[beads]
workspace    = "."
bd_binary    = "bd"
formulas_dir = ".beads/formulas"

[ollama]
url             = "http://localhost:11434"
embedding_model = "nomic-embed-text"
timeout_seconds = 120
num_ctx         = 4096

[secrets]
provider        = "sops"
sops_file       = "./secrets.enc.json"
age_identity    = "~/.broodlink/age-identity"
infisical_url   = "http://localhost:8080"
# infisical_token = ""   # required when provider = "infisical"

[status_api]
port         = 3312
cors_origins = ["http://localhost:1313"]
api_key_name = "BROODLINK_STATUS_API_KEY"

[rate_limits]
requests_per_minute_per_agent = 60
burst                         = 10

[routing]
new_agent_bonus = 1.0

[routing.weights]
capability   = 0.30
success_rate = 0.25
availability = 0.15
cost         = 0.10
recency      = 0.05
domain       = 0.15

[telemetry]
enabled       = true
otlp_endpoint = "http://localhost:4317"
sample_rate   = 1.0

[mcp_server]
enabled                 = true
transport               = "http"      # "http" (streamable), "sse" (legacy), or "stdio"
port                    = 3311
session_timeout_minutes = 30
cors_origins            = ["http://localhost:1313"]

[beads_bridge]
port = 3310

[a2a]
enabled              = true
port                 = 3313
api_key_name         = "BROODLINK_A2A_API_KEY"
bridge_url           = "http://localhost:3310"
ollama_concurrency   = 1
dedup_window_secs    = 30
# bridge_jwt_path defaults to $HOME/.broodlink/jwt-a2a-gateway.token

[memory_search]
decay_lambda = 0.01                                # exponential decay rate (half-life ~69 days, 0 = disabled)
reranker_model = "snowflake-arctic-embed2:137m"    # dedicated reranker model
reranker_enabled = true                            # set false to disable reranking globally
max_content_length = 2000                          # truncate content in results (chars, 0 = no limit)
kg_enabled = true                                  # enable knowledge graph entity extraction
kg_extraction_model = "qwen3:1.7b"                 # model for entity/relationship extraction
kg_entity_similarity_threshold = 0.85              # cosine threshold for entity deduplication
kg_max_hops = 3                                    # max traversal depth for graph_traverse
kg_extraction_timeout_seconds = 120                # timeout for LLM extraction calls (high for cold model loading)
kg_entity_ttl_days = 90                            # 0 = never expire; entities not seen in N days may be pruned
kg_edge_decay_rate = 0.005                         # per-day edge weight reduction (0 = no decay)
kg_cleanup_interval_hours = 24                     # run cleanup every N hours
kg_min_mention_count = 3                           # protect entities with >= N mentions from TTL pruning
smart_chunking = true                              # split at markdown headings, code fences, tables (false = word-based)
query_expansion_enabled = true                     # generate variant phrasings before searching
query_expansion_model = "qwen3:1.7b"               # fast model for query expansion
query_expansion_timeout_seconds = 15               # timeout for expansion LLM call

[collaboration]
max_sub_tasks                    = 10
workspace_ttl_hours              = 24
task_claim_timeout_minutes       = 30
max_declines_per_task            = 3
context_request_timeout_minutes  = 30

[dlq]
auto_retry_enabled  = true
max_retries         = 3
backoff_base_ms     = 1000
check_interval_secs = 60

[jwt]
keys_dir           = "~/.broodlink"
grace_period_hours = 24

[budget]
enabled              = true
daily_replenishment  = 100000
replenish_hour_utc   = 0
low_budget_threshold = 1000
default_tool_cost    = 1

[webhooks]
enabled               = true
delivery_timeout_secs = 10
max_retries           = 3

[chat]
enabled = true
chat_model = "qwen3:30b-a3b"
chat_fallback_model = "qwen3:1.7b"
verifier_model = "deepseek-r1:14b"
verifier_timeout_seconds = 60
chat_code_model = ""
chat_vision_model = "gemma3:27b"
max_context_messages = 10
session_timeout_hours = 24
reply_timeout_seconds = 300
reply_retry_attempts = 3
default_agent_role = "worker"
greeting_enabled = true
greeting_message = "Hello! I'm a Broodlink agent. How can I help?"
memory_enabled     = true
memory_max_results = 3
streaming_enabled = true
streaming_edit_interval_ms = 800
streaming_min_tokens = 30
attachments_dir = "~/.broodlink/attachments"
voice_transcription_enabled = false
chat_transcription_model = "whisper-large-v3-turbo"
transcription_url = "http://localhost:8180"
max_attachment_bytes = 20971520

[chat.tools]
web_search_enabled = true
max_tool_rounds = 3
search_result_count = 5
tool_context_messages = 10
search_cache_ttl_secs = 300
file_tools_enabled = true
allowed_read_dirs  = ["~/broodlink", "~/Documents", "~/Desktop"]
allowed_write_dirs = ["~/broodlink/scratch", "~/Desktop"]
max_read_size_bytes = 10485760
max_write_size_bytes = 1048576
write_approval_timeout_secs = 120
pdf_tools_enabled = true
max_pdf_pages = 100

[notifications]
enabled = true
default_cooldown_minutes = 30

[dashboard_auth]
enabled = false
session_ttl_hours = 8
bcrypt_cost = 12
max_sessions_per_user = 5

[agents.claude]
agent_id           = "claude"
role               = "strategist"
transport          = "mcp"
cost_tier          = "high"
preferred_formulas = ["research", "build-feature"]
model_domains      = ["general", "code"]
skills             = [
    "memory-recall", "memory-store", "task-execution", "self-reporting",
    "report-writing", "task-decomposition", "formula-authoring",
    "code-review", "architectural-planning", "decision-making",
]
system_prompt = "You are a strategic architect and planner. Focus on high-level design, trade-offs, and system-wide decisions. Be thorough in reasoning. Cite evidence from memory when making recommendations. If uncertain, say so."

[agents.qwen3]
agent_id           = "qwen3"
role               = "worker"
transport          = "pymysql"
cost_tier          = "low"
preferred_formulas = ["daily-review", "knowledge-gap"]
model_domains      = ["general"]
skills             = [
    "memory-recall", "memory-store", "task-execution", "self-reporting",
    "semantic-search", "knowledge-graph-query", "knowledge-extraction",
    "web-research", "codebase-analysis", "document-summarization",
]
system_prompt = "You are a diligent research worker. Focus on thorough information gathering, semantic search, and document summarization. Be methodical, cite your sources, and flag gaps in available data."

[agents.a2a-gateway]
agent_id           = "a2a-gateway"
role               = "worker"
transport          = "mcp"
cost_tier          = "low"
preferred_formulas = []
model_domains      = ["general", "code"]
skills             = [
    "memory-recall", "memory-store", "task-execution", "self-reporting",
    "conversational-gateway", "model-failover", "webhook-dispatch",
    "health-monitoring", "formula-execution",
    "incident-response", "notification-dispatch",
]
system_prompt = "You are Broodlink, a helpful and concise AI assistant. Use memory context to personalize responses. When unsure, say so honestly rather than guessing."

[agents.claude-code]
agent_id           = "claude-code"
role               = "strategist"
transport          = "mcp"
cost_tier          = "high"
preferred_formulas = ["build-feature"]
model_domains      = ["general", "code"]
skills             = [
    "memory-recall", "memory-store", "task-execution", "self-reporting",
    "code-generation", "debugging", "testing",
    "migration-authoring", "ci-cd-management",
    "schedule-task",
]
system_prompt = "You are a software engineering specialist. Write clean, tested, maintainable code. Follow existing project conventions. Explain trade-offs when multiple approaches exist."

# ---------------------------------------------------------------------------
# Skill definitions: name → description (shared across agents)
# ---------------------------------------------------------------------------
[skill_definitions]
memory-recall            = "Search and retrieve from persistent memory (topic search, semantic search, full recall)"
memory-store             = "Store structured observations, learnings, and context into persistent memory"
task-execution           = "Claim, execute, and complete queued tasks from the task queue"
self-reporting           = "Log work entries, decisions, and conversation context for auditability"
report-writing           = "Produce structured reports — daily reviews, audits, status updates, postmortems"
task-decomposition       = "Break complex goals into sub-tasks with dependencies and priority ordering"
formula-authoring        = "Design and write multi-step Beads workflow formulas in TOML format"
code-review              = "Review code for correctness, security vulnerabilities, performance, and style"
architectural-planning   = "Design system architecture, evaluate trade-offs, propose migration strategies"
decision-making          = "Weigh alternatives, log structured reasoning, and select optimal path forward"
semantic-search          = "Vector similarity search across memories and knowledge graph entities"
knowledge-graph-query    = "Traverse KG entities and edges, find relationships between concepts"
knowledge-extraction     = "Extract entities and relationships from unstructured text into the knowledge graph"
web-research             = "Search the web, fetch pages, and summarize findings into actionable intelligence"
codebase-analysis        = "Explore repositories, understand architecture, find patterns and dependencies"
document-summarization   = "Condense long documents, logs, or conversations into actionable summaries"
conversational-gateway   = "Handle inbound Slack, Teams, and Telegram messages with session management and routing"
model-failover           = "Detect model OOM/degradation and transparently switch to fallback models"
webhook-dispatch         = "Send event notifications to external webhook endpoints with SSRF protection"
health-monitoring        = "Check service health across all Broodlink components and report anomalies"
formula-execution        = "Run multi-step Beads workflow formulas end-to-end with step orchestration"
code-generation          = "Write new code from specs, natural language descriptions, or existing patterns"
debugging                = "Diagnose failures from logs, stack traces, error messages, and runtime behavior"
testing                  = "Write and run unit tests, integration tests, and regression test suites"
migration-authoring      = "Create SQL migrations for Dolt and Postgres schema changes"
ci-cd-management         = "Interact with CI pipelines, fix failing checks, manage GitHub Actions workflows"
schedule-task            = "Schedule one-shot or recurring tasks with optional formula execution at specified times"
incident-response        = "Auto-detect service anomalies (DLQ spikes, error events, budget exhaustion) and trigger incident postmortems"
notification-dispatch    = "Send proactive alerts to Telegram or Slack when configurable thresholds are crossed"
